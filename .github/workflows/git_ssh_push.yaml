name: Sync to Pages Repository

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 這個步驟是用來檢查你的 Secret 是否真的存在
      # 如果這裡是紅色的，代表你存錯位置了
      - name: Check Secret Exists
        env:
          TEST_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          if [ -z "$TEST_KEY" ]; then
            echo "Error: SSH_PRIVATE_KEY is empty!"
            echo "Please check: Settings -> Secrets and variables -> Actions"
            echo "Make sure it is under 'Repository secrets', NOT 'Repository variables'."
            exit 1
          else
            echo "Success: SSH_PRIVATE_KEY found."
          fi

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Push to Pages Repository
        env:
          TARGET_REPO: "git@github.com:AD-iOS/ad-ios.github.io.git"
          SOURCE_BRANCH: ${{ github.ref_name }}
        run: |
          # 設置遠程倉庫
          git remote add target "$TARGET_REPO"
          
          # 處理 SSH 信任清單
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          
          echo "Starting sync..."
          
          # 強制推送到目標的 master 分支
          git push target "$SOURCE_BRANCH:master" --force
          
          echo "Sync success."